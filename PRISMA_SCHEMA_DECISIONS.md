# Prisma Schema Design Decisions

## DateTime Fields with SQLite/D1

### Why DateTime in Schema but TEXT in Migration?

**This is the correct and intended behavior for Prisma with SQLite.**

Prisma's DateTime type automatically maps to TEXT in SQLite because SQLite doesn't have a native DateTime type. Prisma handles all serialization/deserialization:

```prisma
// In schema.prisma
uploadedAt DateTime? @map("uploaded_at")  // Developer-friendly DateTime type
```

```sql
-- In migration.sql (generated by Prisma)
"uploaded_at" TEXT,  -- SQLite storage format
```

**How it works:**
- Application code uses `new Date()` JavaScript objects
- Prisma serializes to ISO 8601 strings: `"2025-11-10T00:00:00.000Z"`
- SQLite stores as TEXT
- Prisma deserializes back to Date objects when querying

### No Database Defaults

The migration intentionally has **no DEFAULT values** for timestamp fields:

```sql
"created_at" TEXT NOT NULL,      -- No DEFAULT clause
"updated_at" TEXT NOT NULL,      -- No DEFAULT clause
"processed_at" TEXT,             -- Nullable, no DEFAULT
```

**Why?**
1. **Application Control**: Timestamps are always set by application code using `new Date()`
2. **Consistency**: Same timestamp format across all workers (ISO 8601)
3. **Avoid Literal String Bug**: SQLite's `DEFAULT 'CURRENT_TIMESTAMP'` stores the literal string `"CURRENT_TIMESTAMP"`, not an actual timestamp
4. **Correct SQLite Default Would Be**: `DEFAULT (datetime('now'))` - but we don't need it since the app always sets timestamps

## Album Worker Implementation

### Raw D1 SQL vs Prisma

**Current Implementation**: `workers/album/src/index.ts` uses **raw D1 SQL queries**

```typescript
// Current: Raw SQL
await env.DB.prepare(`
  INSERT OR REPLACE INTO media (key, filename, type, size, uploaded_at, created_at, updated_at)
  VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7)
`).bind(fileName, file.name, fileType, file.size, uploadedAt, uploadedAt, uploadedAt).run();
```

**Why Not Prisma?**

The album worker was initially migrated to Prisma `prisma.media.upsert()`, but was reverted to raw SQL due to a **Cloudflare Workers test environment limitation**:

**Issue**: When calling `worker.fetch()` in tests with workers that use both R2 and Prisma (which uses D1 with SQLite), the test environment's isolated storage fails to properly clean up SQLite WAL (Write-Ahead Logging) files.

**Error Message**:
```
Failed to pop isolated storage stack frame
In particular, we were unable to pop R2 storage.
Expected .sqlite, got /tmp/.../miniflare-R2BucketObject/...sqlite-shm
```

**Reference**: https://developers.cloudflare.com/workers/testing/vitest-integration/known-issues/#isolated-storage

### Other Workers Use Prisma Successfully

- **Viewer Worker** (`workers/viewer/src/index.ts`): Uses Prisma ✅
- **Video Streaming Worker** (`workers/video-streaming/src/handlers/hls.ts`): Uses Prisma ✅
- **Maintenance Scripts**: Use Prisma ✅

These workers don't have the same test isolation issues because their tests don't combine `worker.fetch()` + R2 + Prisma simultaneously.

### Future Consideration

If the Cloudflare Workers testing environment fixes the isolated storage issue, the album worker can be migrated back to Prisma:

```typescript
// Future: Prisma upsert (when test environment supports it)
const prisma = createPrismaClient(env.DB);
try {
  await prisma.media.upsert({
    where: { key: fileName },
    create: { /* ... */ },
    update: { /* ... */ }
  });
} finally {
  await prisma.$disconnect();
}
```

## Field Nullability

### processedAt is Nullable

```prisma
processedAt DateTime? @map("processed_at")  // Nullable
```

**Why?**
- Images/videos are uploaded first, then processed asynchronously
- `processedAt` is only set after thumbnail generation completes
- Making it nullable accurately reflects the data lifecycle

### createdAt and updatedAt are Required

```prisma
createdAt DateTime @map("created_at")  // NOT NULL
updatedAt DateTime @map("updated_at")  // NOT NULL
```

**Why?**
- Always set when record is created
- Always updated when record is modified
- Application ensures these are never null

## Migration History

### Initial Migration (20251109221937_init)

**Fixed Issues**:
1. ✅ Removed `DEFAULT 'CURRENT_TIMESTAMP'` (stored literal string instead of timestamp)
2. ✅ Made `processed_at` nullable (was incorrectly NOT NULL)
3. ✅ Kept `created_at` and `updated_at` as NOT NULL (app always provides values)

### Schema Updates (756ac33)

**Changes**:
1. ✅ Converted String → DateTime for all timestamp fields
2. ✅ Updated workers to use `new Date()` instead of `.toISOString()`
3. ✅ Updated test database schema to match migration
4. ✅ Fixed Prisma type-safety tests

## Testing Strategy

### E2E Tests

**3 Tests Skipped** due to isolated storage limitations:
- `should upload image, store in R2, and create database entries`
- `should handle video uploads correctly`
- `should query all media using D1`

**2 Prisma Tests Passing**:
- `should support Prisma type-safe queries with select` ✅
- `should handle Prisma upsert operations` ✅

These passing tests verify Prisma functionality works correctly, even though full E2E tests are skipped.

## Summary

| Aspect | Decision | Reason |
|--------|----------|--------|
| Schema Type | DateTime | Developer-friendly, Prisma handles conversion |
| Storage Type | TEXT | SQLite limitation, Prisma manages automatically |
| Defaults | None | Application controls timestamps |
| Album Worker | Raw SQL | Test environment limitation |
| Other Workers | Prisma | No test isolation issues |
| processedAt | Nullable | Set asynchronously after processing |
| Test Coverage | 10 passed, 3 skipped | Known environment limitation |
